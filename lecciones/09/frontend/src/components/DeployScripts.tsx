import { PolicyId, Unit, Constr } from "lucid-cardano";
import React, { useContext, useState } from "react";
import {
  applyParamsToScript,
  Data,
  MintingPolicy,
  fromText,
} from "lucid-cardano";
import { AppStateContext } from "@/pages/_app";
import { signAndSubmitTx } from "@/utilities/utilities";

export default function DeployScripts() {
  const { appState, setAppState } = useContext(AppStateContext);
  const {
    lucid,
    wAddr,
    oracleScript,
    collateralScript,
    txScriptsDeployment,
  } = appState;
  const [mPerc, setMPerc] = useState(150n);

  const parseMinPerc = (r: string) => {
    const mPerc = BigInt(Number(r));
    if (Number.isNaN(mPerc)) return;
    setMPerc(mPerc);
  };

  const getFinalMintingPolicy = async () => {
    if (!lucid || !wAddr || !oracleScript || !mPerc) return;
    const tn = fromText("USDA");
    const oracleValidatorHash = await lucid.utils.validatorToScriptHash(
      oracleScript
    );
    const collateralValidatorHash = await lucid.utils.validatorToScriptHash(
      collateralScript
    );

    console.log("Applying minting script to these parameters: ", {
      OracleValHash: oracleValidatorHash,
      CollateralValHash: collateralValidatorHash,
      minPercent: mPerc,
    });

    const params = new Constr(0, [oracleValidatorHash, collateralValidatorHash, mPerc]);
    const scPolicy: MintingPolicy = {
      type: "PlutusV2",
      script: applyParamsToScript(
        //"590ebb01000032323232323232323232323232323222323232322533300e3232533301030063012375400226464646464646464646464646464646464646464a666048603401826464a6660540022a6604e0402c264a666056605c0042646464a666054a66605466e21200000314a22a660569211b636865636b5f6d696e745f706f736974697665203f2046616c73650014a02a666054a666054004294454cc0ad24116636865636b5f6d61785f6d696e74203f2046616c73650014a02a666054002294454cc0ad240125636865636b5f636f6c6c61746572616c5f6f75747075745f646174756d203f2046616c73650014a02940528192999815299981519b87375a6018605a6ea800400c5288a99815a48151636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f737461626c65636f696e5f616d6f756e74203d3d20737461626c65636f696e5f6d696e7465645f616d6f756e74203f2046616c73650014a02a666054a66605466e3cdd7180818169baa00101a14a22a66056920142636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f6d696e74696e675f706f6c6963795f6964203d3d20706f6c6963795f6964203f2046616c73650014a02a6660546600e0266eb8c070c0b4dd50008a51153302b491466c6973742e6861732865787472615f7369676e61746f726965732c20636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f6f776e657229203f2046616c73650014a02940528180500199b8900133300f300b3756603460566ea8008010dd6980518159baa0213300b01a017153302802116302c0013300400f375c602e60506ea8078cc008040dd7180518139baa01d132532333026301b00e132533302b001153302802216132533302c302f002132323232533302c533302c3371000490000a51153302d49011b636865636b5f6275726e5f6e65676174697665203f2046616c73650014a02a666058a666058002294454cc0b524120636865636b5f6275726e5f6d6174636865735f646174756d203f2046616c73650014a02a666058006294454cc0b524011d636865636b5f6f776e65725f7369676e6174757265203f2046616c73650014a0294052819b873006375a601a605c6ea800c004cc038074068cc018048dd7180d98161baa0013009001153302902316302d001330053300201423019302a37540026eb8c060c0a4dd500f8991929998160008a998148118b0992999816981800109919192999816299981619b88333013300f3756603c605e6ea8010018dd6980718179baa025300700314a22a6605a920119636865636b5f6c69717569646174696f6e203f2046616c73650014a02a666058a666058002294454cc0b524120636865636b5f6275726e5f6d6174636865735f646174756d203f2046616c73650014a02a666058004294454cc0b524011b636865636b5f6275726e5f6e65676174697665203f2046616c73650014a0294052819b873006375a601a605c6ea8c03000c008cdc4000a40006601a0380322a660540482c605c0026600c6600602a4603460566ea8004dd7180c98151baa02033004012375c601860526ea807cdc0a400044646600200200644a666058002297ae013302d3003302e00133002002302f00122323300100100322533302b00114a0264a66605066e3cdd718170010020a51133003003001302e00122325333029001153302602216132533302a302d002132533333302f0011533028025161533028025161533028025161375a0022a6605004a2c6464a666050603c0022a660529211c436f756c646e27742066696e64206f7261636c65277320646174756d001615333028301d001153302949011d4f7261636c65277320646174756d206973206e6f7420696e6c696e656400161302e302b375400460526ea8004c020c0a4dd5180c18149baa001153302702316302b001330040022325333026301b30283754002266e3cdd7181618149baa00100314a0601660506ea8c02cc0a0dd5180b98141baa00122330030022325333025301a30273754002266e3c00cdd7181598141baa00114a06014604e6ea8c028c09cdd50009119198008008019129998140008a5eb804c8c94ccc098c0140084cc0ac008cc0100100044cc010010004c0b0008c0a80048c8c80094ccc084c05cc08cdd500089929998130008a998118108b0991929998140008a998128118b0991929998150008a998138128b099299981598170010a4c2a6605004c2c64a66666605e0022a6605004c2c2a6605004c2c2a6605004c2c26eb400454cc0a009858c0b0004c0b0008c94cccccc0b400454cc0980905854cc0980905854cc0980905854cc098090584dd7000981500098150011929999998158008a998120110b0a998120110b0a998120110b0a998120110b09bae0013028001302437540022a660440402c64a66666605200220022a660440402c2a660440402c2a660440402c2a660440402c6464a66604460300022a66046920122436f6c6c61746572616c206f757470757420646174756d206973206d697373696e6700161533302230170011533023490126436f6c6c61746572616c206f757470757420646174756d206973206e6f7420696e6c696e65640016130283025375400460466ea8004c008c08cdd500091812981318130009199801800a45004881002233300332330010013756604a604c604c604c604c60446ea8c014c088dd50019129998120008a5eb7bdb1804c8c8c8c94ccc090cdc7a441000021003133029337606ea4008dd3000998030030019bab3026003375c60480046050004604c00200291104555344410022232533301f3014302137540022900009bad30253022375400264a66603e602860426ea8004530103d87a8000132330010013756604c60466ea8008894ccc094004530103d87a8000132323253330243371e00e6eb8c09800c4cdd2a4000660526ea00052f5c026600a00a0046eb4c098008c0a4008c09c004c8cc004004010894ccc090004530103d87a8000132323253330233371e00e6eb8c09400c4cdd2a4000660506e980052f5c026600a00a0046eacc094008c0a0008c0980048c084004888cdc199b8233706006002004904044bd180d1baa00f3758603a603c603c603c603c603c603c0046eb0c070004c070008dd6180d000980d0011bac301800130143754602e60286ea8010dd7180b18099baa001153301149124657870656374204d696e7428706f6c6963795f696429203d206374782e707572706f736500163001301237540044602a602c0022930a99807a491856616c696461746f722072657475726e65642066616c7365001365632533300d300300115333011301037540082930a998070048b0a99980698010008a99980898081baa004149854cc0380245854ccc034cdc3a40080022a66602260206ea8010526153300e00916153300e00916300e37540066e1d2002370e9000299999980880088008a998050028b0a998050028b0a998050028b0a998050028b24971657870656374205b636f6c6c61746572616c5f6f75747075745d3a204c6973743c4f75747075743e203d0a2020202020202020202066696e645f7363726970745f6f757470757473286f7574707574732c20706172616d732e6d705f636f6c6c61746572616c5f76616c696461746f7229004901b2657870656374205b636f6c6c61746572616c5f696e7075745d3a204c6973743c4f75747075743e203d0a2020202020202020202066696e645f7363726970745f6f757470757473280a2020202020202020202020206c6973742e6d617028696e707574732c20666e286929207b20692e6f7574707574207d292c0a202020202020202020202020706172616d732e6d705f636f6c6c61746572616c5f76616c696461746f722c0a20202020202020202020290049011972656465656d65723a204d696e74696e6752656465656d6572004901ff657870656374205b6f7261636c655f696e7075745d203d0a202020206c6973742e66696c746572280a2020202020207265666572656e63655f696e707574732c0a202020202020666e286929207b0a20202020202020207768656e20692e6f75747075742e616464726573732e7061796d656e745f63726564656e7469616c206973207b0a202020202020202020202f2f202f2f2f2049662074686520696e7075742069732066726f6d2061207363726970742c2073617665206974206966206974277320746865206f7261636c652773206f6e650a2020202020202020202053637269707443726564656e7469616c287363726970744861736829202d3e7d2073637269707448617368203d3d206f7261636c655f76616c0a202020202020202020202f2f202f2f2f2049662074686520696e7075742069732066726f6d206120504b482c2064726f70206974200a202020202020202020205f202d3e2046616c73650a20202020202020207d0a2020202020207d2c0a2020202029004901e5657870656374206f7261636c655f726174653a20496e74203d0a202020207768656e206f7261636c655f696e7075742e6f75747075742e646174756d206973207b0a2020202020204e6f446174756d202d3e206661696c204022436f756c646e27742066696e64206f7261636c65277320646174756d220a202020202020446174756d48617368285f646174756d5f6861736829202d3e206661696c2040224f7261636c65277320646174756d206973206e6f7420696e6c696e6564220a202020202020496e6c696e65446174756d28646174756d29202d3e20646174756d0a202020207d004901f4657870656374206f75747075745f646174756d3a20436f6c6c61746572616c446174756d203d0a202020207768656e206f75747075742e646174756d206973207b0a2020202020204e6f446174756d202d3e206661696c204022436f6c6c61746572616c206f757470757420646174756d206973206d697373696e67220a202020202020446174756d48617368285f646174756d5f6861736829202d3e206661696c204022436f6c6c61746572616c206f757470757420646174756d206973206e6f7420696e6c696e6564220a202020202020496e6c696e65446174756d28646174756d29202d3e20646174756d0a202020207d005734ae7155ceaab9e5573eae815d0aba257481",
        "590ef001000032323232323232323232323232323222323232322533300e3232533301030063012375400226464646464646464646464646464646464646464a666048603401826464a6660540022a6604e0402c264a666056605c0042646464a666054a66605466e21200000314a22a660569211b636865636b5f6d696e745f706f736974697665203f2046616c73650014a02a666054a666054004294454cc0ad24116636865636b5f6d61785f6d696e74203f2046616c73650014a02a666054002294454cc0ad240125636865636b5f636f6c6c61746572616c5f6f75747075745f646174756d203f2046616c73650014a02940528192999815299981519b87375a6018605a6ea800400c5288a99815a48151636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f737461626c65636f696e5f616d6f756e74203d3d20737461626c65636f696e5f6d696e7465645f616d6f756e74203f2046616c73650014a02a666054a66605466e3cdd7180818169baa00101a14a22a66056920142636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f6d696e74696e675f706f6c6963795f6964203d3d20706f6c6963795f6964203f2046616c73650014a02a6660546600e0266eb8c070c0b4dd50008a51153302b491466c6973742e6861732865787472615f7369676e61746f726965732c20636f6c6c61746572616c5f6f75747075745f646174756d2e636f6c5f6f776e657229203f2046616c73650014a02940528180500199b8900133300f300b3756603460566ea8008010dd6980518159baa0213300b01a017153302802116302c0013300400f375c602e60506ea8078cc008040dd7180518139baa01d132532333026301b00e132533302b001153302802216132533302c302f002132323232533302c533302c3371000490000a51153302d49011b636865636b5f6275726e5f6e65676174697665203f2046616c73650014a02a666058a666058002294454cc0b524120636865636b5f6275726e5f6d6174636865735f646174756d203f2046616c73650014a02a666058006294454cc0b524011d636865636b5f6f776e65725f7369676e6174757265203f2046616c73650014a0294052819b873006375a601a605c6ea800c004cc038074068cc018048dd7180d98161baa0013009001153302902316302d001330053300201423019302a37540026eb8c060c0a4dd500f8991929998160008a998148118b0992999816981800109919192999816299981619b88333013300f3756603c605e6ea8010018dd6980718179baa025300700314a22a6605a920119636865636b5f6c69717569646174696f6e203f2046616c73650014a02a666058a666058002294454cc0b524120636865636b5f6275726e5f6d6174636865735f646174756d203f2046616c73650014a02a666058004294454cc0b524011b636865636b5f6275726e5f6e65676174697665203f2046616c73650014a0294052819b873006375a601a605c6ea8c03000c008cdc4000a40006601a0380322a660540482c605c0026600c6600602a4603460566ea8004dd7180c98151baa02033004012375c601860526ea807cdc0a400044646600200200644a666058002297ae013302d3003302e00133002002302f00122323300100100322533302b00114a0264a66605066e3cdd718170010020a51133003003001302e00122325333029001153302602216132533302a302d002132533333302f0011533028025161533028025161533028025161375a0022a6605004a2c6464a666050603c0022a660529211c436f756c646e27742066696e64206f7261636c65277320646174756d001615333028301d001153302949011d4f7261636c65277320646174756d206973206e6f7420696e6c696e656400161302e302b375400460526ea8004c020c0a4dd5180c18149baa001153302702316302b001330040022325333026301b30283754002266e3cdd7181618149baa00100314a0601660506ea8c02cc0a0dd5180b98141baa00122330030022325333025301a30273754002266e3c00cdd7181598141baa00114a06014604e6ea8c028c09cdd50009119198008008019129998140008a5eb804c8c94ccc098c0140084cc0ac008cc0100100044cc010010004c0b0008c0a80048c8c80094ccc084c05cc08cdd500089929998130008a998118108b0991929998140008a998128118b0991929998150008a998138128b099299981598170010a4c2a6605004c2c64a66666605e0022a6605004c2c2a6605004c2c2a6605004c2c26eb400454cc0a009858c0b0004c0b0008c94cccccc0b400454cc0980905854cc0980905854cc0980905854cc098090584dd7000981500098150011929999998158008a998120110b0a998120110b0a998120110b0a998120110b09bae0013028001302437540022a660440402c64a66666605200220022a660440402c2a660440402c2a660440402c2a660440402c6464a66604460300022a66046920122436f6c6c61746572616c206f757470757420646174756d206973206d697373696e6700161533302230170011533023490126436f6c6c61746572616c206f757470757420646174756d206973206e6f7420696e6c696e65640016130283025375400460466ea8004c008c08cdd500091812981318130009199801800a45004881002233300332330010013756604a604c604c604c604c60446ea8c014c088dd50019129998120008a5eb7bdb1804c8c8c8c94ccc090cdc8a44100002153330243371e91010000210031005133029337606ea4008dd3000998030030019bab3026003375c60480046050004604c00200291104555344410022232533301f3014302137540022900009bad30253022375400264a66603e602860426ea8004530103d87a8000132330010013756604c60466ea8008894ccc094004530103d87a80001323232325333025337220100042a66604a66e3c0200084cdd2a4000660546ea00052f5c02980103d87a8000133006006003375a604e0066eb8c094008c0a4008c09c004c8cc004004010894ccc0900045300103d87a80001323232325333024337220100042a66604866e3c0200084cdd2a4000660526e980052f5c02980103d87a80001330060060033756604c0066eb8c090008c0a0008c0980048c084004888cdc199b8233706006002004904044bd180d1baa00f3758603a603c603c603c603c603c603c0046eb0c070004c070008dd6180d000980d0011bac301800130143754602e60286ea8010dd7180b18099baa0011533011490124657870656374204d696e7428706f6c6963795f696429203d206374782e707572706f736500163001301237540044602a602c0022930a99807a491856616c696461746f722072657475726e65642066616c7365001365632533300d300300115333011301037540082930a998070048b0a99980698010008a99980898081baa004149854cc0380245854ccc034cdc3a40080022a66602260206ea8010526153300e00916153300e00916300e37540066e1d2002370e9000299999980880088008a998050028b0a998050028b0a998050028b0a998050028b24971657870656374205b636f6c6c61746572616c5f6f75747075745d3a204c6973743c4f75747075743e203d0a2020202020202020202066696e645f7363726970745f6f757470757473286f7574707574732c20706172616d732e6d705f636f6c6c61746572616c5f76616c696461746f7229004901b2657870656374205b636f6c6c61746572616c5f696e7075745d3a204c6973743c4f75747075743e203d0a2020202020202020202066696e645f7363726970745f6f757470757473280a2020202020202020202020206c6973742e6d617028696e707574732c20666e286929207b20692e6f7574707574207d292c0a202020202020202020202020706172616d732e6d705f636f6c6c61746572616c5f76616c696461746f722c0a20202020202020202020290049011972656465656d65723a204d696e74696e6752656465656d6572004901ff657870656374205b6f7261636c655f696e7075745d203d0a202020206c6973742e66696c746572280a2020202020207265666572656e63655f696e707574732c0a202020202020666e286929207b0a20202020202020207768656e20692e6f75747075742e616464726573732e7061796d656e745f63726564656e7469616c206973207b0a202020202020202020202f2f202f2f2f2049662074686520696e7075742069732066726f6d2061207363726970742c2073617665206974206966206974277320746865206f7261636c652773206f6e650a2020202020202020202053637269707443726564656e7469616c287363726970744861736829202d3e7d2073637269707448617368203d3d206f7261636c655f76616c0a202020202020202020202f2f202f2f2f2049662074686520696e7075742069732066726f6d206120504b482c2064726f70206974200a202020202020202020205f202d3e2046616c73650a20202020202020207d0a2020202020207d2c0a2020202029004901e5657870656374206f7261636c655f726174653a20496e74203d0a202020207768656e206f7261636c655f696e7075742e6f75747075742e646174756d206973207b0a2020202020204e6f446174756d202d3e206661696c204022436f756c646e27742066696e64206f7261636c65277320646174756d220a202020202020446174756d48617368285f646174756d5f6861736829202d3e206661696c2040224f7261636c65277320646174756d206973206e6f7420696e6c696e6564220a202020202020496e6c696e65446174756d28646174756d29202d3e20646174756d0a202020207d004901f4657870656374206f75747075745f646174756d3a20436f6c6c61746572616c446174756d203d0a202020207768656e206f75747075742e646174756d206973207b0a2020202020204e6f446174756d202d3e206661696c204022436f6c6c61746572616c206f757470757420646174756d206973206d697373696e67220a202020202020446174756d48617368285f646174756d5f6861736829202d3e206661696c204022436f6c6c61746572616c206f757470757420646174756d206973206e6f7420696e6c696e6564220a202020202020496e6c696e65446174756d28646174756d29202d3e20646174756d0a202020207d005734ae7155ceaab9e5573eae815d0aba257481",
        [params]
      ),
    };
    const scPolicyId: PolicyId = lucid!.utils.mintingPolicyToId(scPolicy);

    const unit: Unit = scPolicyId + tn;
    const potentialStateUpdate = {
      scPolicyIdHex: scPolicyId,
      scTokenNameHex: tn,
      scAssetClassHex: unit,
      scPolicy: scPolicy,
      minPercent: Number(mPerc),
      oracleScriptHash: oracleValidatorHash,
      collateralScriptHash: collateralValidatorHash,
    };

    return potentialStateUpdate;
  };

  const deployBothScriptsInOneTx = async () => {
    if (!lucid || !wAddr || txScriptsDeployment) return;
    console.log("deployBothScriptsInOneTx -> appState: ", appState);
    const psu = await getFinalMintingPolicy();
    if (!psu?.scPolicy) return;
    const tx = await lucid
      .newTx()
      .payToAddressWithData(
        wAddr,
        { inline: Data.void(), scriptRef: collateralScript },
        {}
      )
      .payToAddressWithData(
        wAddr,
        { inline: Data.void(), scriptRef: psu.scPolicy },
        {}
      )
      .complete();

    const pid = await signAndSubmitTx(tx);

    setAppState({
      ...appState,
      ...psu,
      txScriptsDeployment: pid,
    });
  };

  return (
    <div className="flex flex-col justify-center items-center">
      <div className="flex flex-row w-full justify-center items-center my-8 text-lg text-zinc-800 font-quicksand">
        <p>Minimum Percentage of Collateral:</p>
        <input
          type="number"
          value={Number(mPerc)}
          onChange={(e) => parseMinPerc(e.target.value)}
          className="w-16 py-1 px-2 ml-2 border border-zinc-700 rounded"
        />
      </div>
      <button
        onClick={deployBothScriptsInOneTx}
        disabled={
          !wAddr || !oracleScript || !mPerc || !!txScriptsDeployment
        }
        className="rounded-lg py-3 px-8 max-w-sm text-zinc-50 bg-zinc-800 shadow-[0_5px_0px_0px_rgba(0,0,0,0.6)] disabled:active:translate-y-0 disabled:active:shadow-[0_5px_0px_0px_rgba(0,0,0,0.2)] disabled:bg-zinc-200  disabled:shadow-[0_5px_0px_0px_rgba(0,0,0,0.2)] disabled:text-zinc-600 font-quicksand font-bold active:translate-y-[2px] active:shadow-[0_4px_0px_0px_rgba(0,0,0,0.6)]"
      >
        {" "}
        Deploy Scripts
      </button>
    </div>
  );
}
